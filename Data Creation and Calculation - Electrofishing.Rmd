---
title: 'Survey Change Investigation'
author: "Joseph C. Ballenger, PhD"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: "hide"
    dev: "png"
    fig_height: 4.5
    fig_width: 6.5
    highllight: "tango"
    keep_md: TRUE
    smart: TRUE
    toc: TRUE
    toc_depth: 2
    toc_float: TRUE
    df_print: "paged"
  pdf_document:
    toc: TRUE
    toc_depth: 2
    fig.width: 13.33
    fig.height: 7.5
    fig.crop: TRUE
    dev: "png"
    df_print: "tibble"
    highlight: "tango"
    keep_tex: TRUE
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# knitr options setting
knitr::opts_chunk$set(autodep = TRUE, fig.show = 'asis', fig.width = 13.33,
                      fig.height = 7.5, dev = "png", tidy = TRUE, 
                      dev.args = list(type = "windows", family = "serif"), 
                      dpi = 800, cache = TRUE, message = FALSE, echo = TRUE,
                      warning = FALSE)
# Number printing options
options(digits = 4)
# Required libraries
library(tidyverse)
library(FSA)
library(extrafont)
library(readxl)
library(survey)
```

```{r}
fig.width.powerpoint <- 13.33
fig.height.powerpoint <- 7.5
fig.width.word.l <- 6.5
fig.width.word.p <- 9
fig.height.word.l <- 3.5
fig.height.word.p <- 6

font.size.word <- 12
font.size.powerpoint <- 18
```

```{r}
# Electrofishing Analysis criteria
begdate.electro <- "2001-01-01"
enddate.electro <- "2019-12-31"
minduration <- 10
maxduration <- 30
SelectTide.electro <- c(1, 2, 5, 6, 7, 8)
SelectMRIPArea <- "Inland"
n.samplespermonth <- 3
n.samplingyears <- 2
DeletedSites <- c("0656", "0655", "0466", "0658", "0071")
Stratum.Selected <- c("CM", "LE", "UA", "UC", "EW")
YearStratumCombos.Electro <- c("1998-EW", "1998-UC", "1999-UC", "1999-EW",
                               "2000-CM", "2000-EW", "2001-EW", "2002-EW",
                               "2002-EW")
```

```{r}
# Output storage lists
Table <- list()
Figures <- list()
```

# Electrofishing Raw Data File and Initial Filtering
```{r}
# Electrofishing Raw Data
setwd('D:/Status of Stocks/Electrofishing/')
Electro.Raw <- read_excel("RawElectrofishingAbundanceData.xlsx", 
                          sheet = "ElectrofishingAbundance6")
names(Electro.Raw) <- c("Collection", names(Electro.Raw)[-1])
Electro.Raw <- Electro.Raw %>%
  filterD(Date >= begdate.electro) %>%
  filterD(Date <= enddate.electro) %>%
  filterD(Area %in% 
            names(sapply(dimnames(table(Electro.Raw$Year, 
                                        Electro.Raw$Area))[[2]], 
                         FUN = function(x) {
                           length(which(table(Electro.Raw$Year, 
                                              Electro.Raw$Area)[, x] > 
                                          n.samplespermonth))
                         })[sapply(dimnames(table(Electro.Raw$Year, 
                                                  Electro.Raw$Area))[[2]], 
                                   FUN = function(x) {
                                     length(which(
                                       table(Electro.Raw$Year, 
                                             Electro.Raw$Area)[, x] > 
                                         n.samplespermonth))
                                   }) > n.samplingyears])) %>%
  mutate(DOY = as.numeric(format(Date, "%j")),
         Area2 = mapvalues(Area, 
                           from = c("AB", "AS", "CP", "SA", "WB"),
                           to = c("ACE Basin", "Charleston Harbor", 
                                  "Charleston Harbor", 
                                  "Santee Delta", "Winyah Bay")),
         YearArea = paste(Year, Area2, sep = "-")) %>%
  rename(Bowfin = `Note: Family (Bowfins)`) %>%
  select(Collection:Date, Wave:Duration, DOY:YearArea,
         25:length(Electro.Raw))
```

Initial Filtering Criteria: 

* Valid Dates of the Survey
+ Start Date of Survey - `r begdate.electro` 
+ Beginning date of survey data to include in subsequent analyses
+ End Date of Survey`r enddate.electro` 
+ End date of survey data to include in subsequent analyses
* Valid Areas of the Survey
+ The survey has periodically sampled some areas over a short number of years and/or with low sampling intensity; thus, for this analysis we want to remove such areas from consideration because they are traditionally not considered part of the general survey
+ First, we first remove any areas that were not sampled for more than `r n.samplingyears` years
+ Second, we remove additioanl areas that were not sampled, on average, more than `r n.samplespermonth` times per month when sampled

```{r}
# Assigning Sites to appropriate strata
# Charleston Harbor
Electro.Raw$Stratum[Electro.Raw$Site == "0154"] <- "UC"
Electro.Raw$Stratum[Electro.Raw$Site == "0324"] <- "UC"
Electro.Raw$Stratum[Electro.Raw$Site == "0411"] <- "UC"
Electro.Raw$Stratum[Electro.Raw$Site == "0202"] <- "UC"
# Santee Delta
Electro.Raw$Stratum[Electro.Raw$Site == "0652"] <- "NS"
Electro.Raw$Stratum[Electro.Raw$Site == "0653"] <- "NS"
# Winyah Bay
Electro.Raw$Stratum[Electro.Raw$Site == "0761"] <- "EW"
Electro.Raw$Stratum[Electro.Raw$Site == "0842"] <- "EW"
Electro.Raw$Stratum[Electro.Raw$Site == "0792"] <- "EW"
Electro.Raw$Stratum[Electro.Raw$Site == "0847"] <- "EW"
Electro.Raw$Stratum[Electro.Raw$Site == "0872"] <- "EW"
Electro.Raw$Stratum[Electro.Raw$Site == "0612"] <- "EW"
```

```{r}
# Filtering based on strata we develop indices for:
Electro.Raw <- Electro.Raw  %>%
  filterD(Stratum %in% Stratum.Selected)
```

* Valid Strata for the Survey
+ We only include data from the following strata: 

```{r}
Stratum.Selected
```

```{r}
# Some electrofishing data set filtering
Electro <- Electro.Raw %>%
  filter(!Site %in% DeletedSites) %>% # Filtering to appropriate sites
  filterD(Duration >= minduration & Duration <= maxduration ) %>% # 
  # collections where we had a measured sample duration in minutes, and
  filterD(Tide %in% SelectTide.electro) %>% # appropriate tidal stages.
  mutate(YearStratum = paste(Year, Stratum, sep = "-")) %>%
  filter(!YearStratum %in% YearStratumCombos.Electro) %>% # Filtering to 
  # appropriate year-stratum combos
  select(-c(YearStratum, Temp_Air, YearArea)) %>% # Deleting some un-needed
  # columns
  mutate(Site = factor(Site), # Mutating some variables to convert them to
         Stratum = factor(Stratum), # the appropriate form
         Area = factor(Area),
         Area2 = factor(Area2),
         Month = factor(Month),
         Tide = factor(Tide)) %>%
  select(Collection:Area, Area2, everything()) # Selecting appropriate 
# columns
```

* Valid Sites for the Survey
+ We remove any collections made at sites that should be deleted from the analysis
+ These sites are deleted generally because they were only sampled either in a single year or only a very few times during the history of the survey

```{r}
DeletedSites
```

* Valid Collection Durations for the Survey
+ Minimum Duration - `r minduration` minutes 
+ Minimum electrofishing collection sampling duration to consider it a valid sample
+ Shorter durations indicate issues with the collection (e.g., generator failure)
+ Maximum Duration - `r maxduration` minutes 
+ Maximum electrofishing colleciton sampling duration to consider it a valid sample
+ Longer durations indicate issues with the collection (e.g., not part of typical survey design)
* Valid Tidal Stages for the Survey
+ The electrofishing survey targets sampling certain stages of the tidal cycle, thus any collections made outside of these tidal stages are not directly comparable. Thus we remove any collections not part of the survey design by retaining only the following tidal stages in our analysis: 

```{r}
SelectTide.electro
```

* Valid Year-Stratum Combinations for the Survey
+ Certain year-stratum combinations should be removed from analyses. This typically represent year-stratum combinations where sampling was not standardized. Generally speaking, this occurs during the 1st one or two years of surveying a particular stratum
+ The removed year-stratum combinations are:

```{r}
YearStratumCombos.Electro
```

# Summary Tables
## Abundance, by Species, of Fish Captured in the Electrofishing Survey
```{r}
# Creating a table with the abundance, by species, of fish captured in the 
# Electrofishing survey
Table4 <- data.frame(Name = colnames(Electro)[23:length(Electro)],
                     Abundance = colSums(Electro[, 23:length(Electro)]))
Table4 <- Table4[order(-Table4$Abundance), ]
Table4$Name <- gsub(".", " ", Table4$Name, fixed = TRUE)
Table4 <- Table4[Table4$Abundance > 0, ]
Table4$Rank <- rank(-Table4$Abundance, ties.method = "min")
Table4$Order <- seq(1:dim(Table4)[1])
Species.Codes <- read.csv("Species Codes.csv")
Table4 <- Table4 %>%
    merge(Species.Codes[,2:4], by.x = "Name", by.y = "Common.Name", 
          all.x = TRUE) %>%
    select(Order, Scientific.Name, Name, Family.Name, Abundance, Rank)
colnames(Table4) <- c("Order", "Scientific.Name", "Common.Name", "Family", 
                      "Abundance", "Rank")
Table4 <- Table4[order(-Table4$Abundance), ]
Table4 <- rbind(Table4, 
                c("", "", "", "Total", colSums(Table4[5]),
                  ""))
Table4$Abundance <- as.numeric(Table4$Abundance)
(Table$Electro$SpeciesAbundance <- Table4)
rm(Table4)
```

## Abundance, by Species, of Fish Captured in the Electrofishing Survey
```{r}
Table4 <- Electro %>%
  select(Year, colnames(Electro)[23:length(Electro)]) %>%
  gather(key = "Species", value = "Abundance", 
         `American Eel`:`Yellow Perch`) %>%
  group_by(Year, Species) %>%
  summarize(Abundance = sum(Abundance)) %>%
  ungroup()
write.csv(Table4, "Species Abundance by Year.csv", row.names = FALSE)
(Table$Electro$SpeciesAbundancebyYear <- Table4)
rm(Table4)
```

# Species Considered for Analysis
## Species of Interest Electrofishing Survey
Here, we identify the list of species for which we have averaged catching more than 50 individuals in the survey annually:

```{r}
Species.Electro <- Table$Electro$SpeciesAbundance$Common.Name[Table$Electro$SpeciesAbundance$Abundance > length(unique(Electro$Year)) * 50] # Restricting to 
# species where we captured a minimum of 50 individuals on average annually
Species.Electro <- Species.Electro[Species.Electro != ""]
Species.Electro
```

The list of species, along with the minimum and maximum month of electrofishing collecitons considered in species specific analyses, are found here:

```{r}
Selections <- read.csv("Electrofishing Species and Survey Months.csv", 
                       header = TRUE) %>%
  rename(`Minimum Month` = Min,
         `Maximum Month` = Max) %>%
  filter(Common %in% Species.Electro) %>%
  dplyr::select(Common:`Maximum Month`)
Selections
```

```{r}
rm(DeletedSites, n.samplespermonth, n.samplingyears, SelectMRIPArea, 
   Stratum.Selected, begdate.electro, enddate.electro, SelectTide.Electro, YearStratumCombos.Electro,
   minduration, maxduration)
```

# Average Catch by Year and Stratum by Species
```{r}
Electro.long <- Electro %>%
  gather(key= "Species", value = "Abundance", 
         'American Eel':'Yellow Perch', na.rm = TRUE) %>%
  filter(Species %in% Species.Electro) %>%
  mutate(Month = as.numeric(as.character(Month)),
         CPUE = Abundance / Duration * 15)
```

```{r, message = FALSE, warning = FALSE}
electrodesign <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                           data = Electro.long, check.strata = TRUE)
```

```{r, warning = FALSE}
CPUE.Results <- data.frame()
for(species in Species.Electro) {
  tmp <- Electro.long[Electro.long$Species == species, ]
  tmp <- tmp %>%
    filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                 species] &
             Month <= Selections$`Maximum Month`[Selections$Common == 
                                                   species])
  design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                      data = tmp, check.strata = TRUE)
  CPUE <- svyby(~ CPUE, by = ~ Year, 
                design = design, FUN = svymean,
                vartype = c("se", "ci", "cv"), drop.empty.groups = TRUE)
  CPUE$Species <- species
  CPUE.Results <- rbind(CPUE.Results, CPUE, row.names = NULL)
}
```

```{r}
CPUE.Summary.Year.Org <- CPUE.Results %>%
  group_by(Species, Year) %>%
  summarize(n = sum(!is.na(cv)),
            Median.CV = median(cv, na.rm = TRUE),
            Min = min(cv, na.rm = TRUE),
            Lower = quantile(cv, 0.025, na.rm = TRUE),
            Avg.CV = mean(cv, na.rm = TRUE),
            Upper = quantile(cv, 0.0975, na.rm = TRUE),
            Max = max(cv, na.rm = TRUE)) %>%
  filter(!is.na(Avg.CV))
CPUE.Summary.Year.Org
```

```{r}
CPUE.Summary.Org <- CPUE.Results %>%
  filter(Year %in% c(2003:2018)) %>%
  group_by(Species) %>%
  summarize(n = sum(!is.na(cv)),
            Median.CV = median(cv, na.rm = TRUE),
            Min = min(cv, na.rm = TRUE),
            Lower = quantile(cv, 0.025, na.rm = TRUE),
            Avg.CV = mean(cv, na.rm = TRUE),
            Upper = quantile(cv, 0.0975, na.rm = TRUE),
            Max = max(cv, na.rm = TRUE)) %>%
  filter(!is.na(Avg.CV)) %>%
  arrange(Median.CV)
CPUE.Summary.Org
write.csv(CPUE.Summary.Org, "CV Sumarries by Species - Original - Electrofishing.csv", 
          row.names = FALSE)
write.csv(CPUE.Results, "Annual CPUE by Species - Original - Electrofishing.csv",
          row.names = FALSE)
```

# Sample Data Sets
```{r}
Electro.long.nest <- as_tibble(Electro.long) %>%
  mutate(StratumYear = paste(Stratum, Year, sep = "")) %>%
  nest(-StratumYear)
Iter <- 1000
telliter <- 100
```

```{r}
# Setup Parallel Backend to Use Many Processors
# cores <- detectCores()
# cl <- makeCluster(cores[1] - 1) # Not to overload your computer
# registerDoParallel(cl)
# clusterEvalQ(cl, c(library(tidyverse), library(survey)))
```

## 6 Months of Sampling Per Year
```{r}
months <- 6
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Trammel.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(1:12, months)))) %>%
    unnest()
  for(species in Species.Trammel) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to 6 months - Electrofishing.csv", 
          row.names = FALSE)
```

## 7 Months of Sampling Per Year
```{r}
months <- 7
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(1:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to 7 months - Electrofishing.csv", 
          row.names = FALSE)
```

## 8 Months of Sampling Per Year
```{r}
months <- 8
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(1:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to 8 months - Electrofishing.csv", 
          row.names = FALSE)
```

## 9 Months of Sampling Per Year
```{r}
months <- 9
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(1:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to 9 months - Electrofishing.csv", 
          row.names = FALSE)
```

## 10 Months of Sampling Per Year
```{r}
months <- 10
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(1:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to 10 months - Electrofishing.csv", 
          row.names = FALSE)
```

## 11 Months of Sampling Per Year
```{r}
months <- 11
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(1:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to 11 months - Electrofishing.csv", 
          row.names = FALSE)
```

## February - December Sampling
```{r}
months <- 2:12
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(species in Species.Electro) {
  tmp <- Electro.long[Electro.long$Species == species & 
                        Electro.long$Month %in% months, ]
  tmp <- tmp %>%
    filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                 species] &
             Month <= Selections$`Maximum Month`[Selections$Common == 
                                                   species])
  design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                      data = tmp, check.strata = TRUE)
  CPUE <- svyby(~ Abundance, by = ~ Year, 
                design = design, FUN = svymean,
                vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
  CPUE$Species <- species
  CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - Sub-Setting Sampling to February - December - Electrofishing.csv", 
          row.names = FALSE)
```

## March - December Sampling
```{r}
months <- 3:12
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(species in Species.Electro) {
  tmp <- Electro.long[Electro.long$Species == species & 
                        Electro.long$Month %in% months, ]
  tmp <- tmp %>%
    filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                 species] &
             Month <= Selections$`Maximum Month`[Selections$Common == 
                                                   species])
  design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                      data = tmp, check.strata = TRUE)
  CPUE <- svyby(~ Abundance, by = ~ Year, 
                design = design, FUN = svymean,
                vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
  CPUE$Species <- species
  CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - Sub-Setting Sampling to March - December - Electrofishing.csv", 
          row.names = FALSE)
```

## March - November Sampling
```{r}
months <- 3:11
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
start_time <- Sys.time()
for(species in Species.Electro) {
  tmp <- Electro.long[Electro.long$Species == species & 
                        Electro.long$Month %in% months, ]
  tmp <- tmp %>%
    filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                 species] &
             Month <= Selections$`Maximum Month`[Selections$Common == 
                                                   species])
  design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                      data = tmp, check.strata = TRUE)
  CPUE <- svyby(~ Abundance, by = ~ Year, 
                design = design, FUN = svymean,
                vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
  CPUE$Species <- species
  CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - Sub-Setting Sampling to March - November - Electrofishing.csv", 
          row.names = FALSE)
```

## February - December Sampling
### 10 Months of Sampling Per Year
```{r}
months <- 10
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(2:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to February - December and 10 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 9 Months of Sampling Per Year
```{r}
months <- 9
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(2:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to February - December and 9 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 8 Months of Sampling Per Year
```{r}
months <- 8
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(2:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to February - December and 8 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 7 Months of Sampling Per Year
```{r}
months <- 7
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(2:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to February - December and 7 months per year.csv - Electrofishing", 
          row.names = FALSE)
```

### 6 Months of Sampling Per Year
```{r}
months <- 6
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(2:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to February - December and 6 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

## March - December Sampling
### 9 Months of Sampling Per Year
```{r}
months <- 9
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(3:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to March - December and 9 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 8 Months of Sampling Per Year
```{r}
months <- 8
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(3:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to March - December and 8 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 7 Months of Sampling Per Year
```{r}
months <- 7
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(3:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to March - December and 7 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 6 Months of Sampling Per Year
```{r}
months <- 6
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(3:12, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to March - December and 6 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

## March - November Sampling
### 8 Months of Sampling Per Year
```{r}
months <- 8
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(3:11, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to March - November and 8 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 7 Months of Sampling Per Year
```{r}
months <- 7
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(3:11, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to March - November and 7 months per year - Electrofishing.csv", 
          row.names = FALSE)
```

### 6 Months of Sampling Per Year
```{r}
months <- 6
CPUE.Results.Subset <- data.frame()
```

```{r, warning = FALSE}
set.seed(1234)
start_time <- Sys.time()
for(i in 1:Iter) {
  tmp <- Electro.long.nest %>%
    mutate(data = map2(StratumYear, data, ~ .y %>% 
                         filter(Month %in% sample(3:11, months)))) %>%
    unnest()
  for(species in Species.Electro) {
    tmp2 <- tmp[tmp$Species == species, ]
    tmp2 <- tmp2 %>%
      filter(Month >= Selections$`Minimum Month`[Selections$Common == 
                                                   species] &
               Month <= Selections$`Maximum Month`[Selections$Common == 
                                                     species])
    design <- svydesign(ids = ~ 1, strata = ~ Stratum, 
                        data = tmp2, check.strata = TRUE)
    CPUE <- svyby(~ Abundance, by = ~ Year, 
                  design = design, FUN = svymean,
                  vartype = c("se", "ci", "cv"), drop.empty.groups = FALSE)
    CPUE$Species <- species
    CPUE$Run <- i
    CPUE.Results.Subset <- rbind(CPUE.Results.Subset, CPUE, row.names = NULL)
  }
  if(i %% telliter == 0) cat(paste("iteration", i, "complete\n"))
}
end_time <- Sys.time()
end_time - start_time
```

```{r}
write.csv(CPUE.Results.Subset, 
          "Annual CPUE by Species - 1000 iterations of Sub-Setting Sampling to March - November and 6 months per year - Electrofishing.csv", 
          row.names = FALSE)
```